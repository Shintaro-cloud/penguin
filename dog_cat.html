const IMG_SIZE = 50;
let model;

async function loadModel() {
  try {
    model = await tf.loadLayersModel('tfjs_model/model.json');
    console.log('モデル読み込み完了:', model);
  } catch (e) {
    console.error('モデル読み込み失敗:', e);
  }
}

function preprocessImage(image) {
  console.log('画像を前処理中...');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(image, 0, 0, IMG_SIZE, IMG_SIZE);
  const imageData = ctx.getImageData(0, 0, IMG_SIZE, IMG_SIZE);
  const tensor = tf.browser.fromPixels(imageData).toFloat().div(255).expandDims(0);
  console.log('テンソル形状:', tensor.shape);
  return tensor;
}

document.getElementById('imageInput').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) {
    console.log('ファイルが選択されていません');
    return;
  }
  console.log('ファイル選択:', file.name);

  const img = new Image();
  img.onload = async () => {
    console.log('画像が読み込まれました');
    try {
      const inputTensor = preprocessImage(img);
      const prediction = await model.predict(inputTensor).data();
      console.log('予測結果:', prediction);
      const dogProb = prediction[0];
      const catProb = prediction[1];
      const resultText = dogProb > catProb ? '🐶 犬と判定されました' : '🐱 猫と判定されました';
      document.getElementById('result').innerText = `${resultText}（犬: ${(dogProb*100).toFixed(1)}%、猫: ${(catProb*100).toFixed(1)}%）`;
    } catch (e) {
      console.error('予測処理でエラー:', e);
      document.getElementById('result').innerText = '判定中にエラーが発生しました。';
    }
  };
  img.onerror = () => {
    console.error('画像の読み込みに失敗しました。');
    document.getElementById('result').innerText = '画像の読み込みに失敗しました。';
  };
  img.src = URL.createObjectURL(file);
});

loadModel();

